# ディスク

## 概要

- 読み書きするファイルはヒープファイル構造
  - ヒープファイル: ファイルをページという固定の長さごとに区切ったファイル
  - I/O 操作はページ単位 (最小の I/O 単位はページ)
  - 読み込み元、書き込み先のページは PageId で指定
- ページサイズは 4096 バイト (4KB)
- テーブルごとに個別のディスクファイルを持つ
  - ファイル名は `{table_name}.db`
  - 各テーブルは FileId を持ち、対応するディスクファイルに格納される
  - テーブル本体とそのインデックスは同じディスクファイル (同じ FileId) を共有する

## PageId の構造

- PageId はディスクファイルとファイル内のページを特定するための識別子
- 複数のディスクファイル内で一意にページを特定できるようにする
  - FileId: ディスクファイルの識別子
  - PageNumber: ファイル内のページ番号

## 最小の I/O 単位をページにする理由

- ファイルはファイルシステムによって HDD や SDD などのデバイスに書き込まれる
- この際ファイルシステムはブロック単位でデバイスに読み書きする (つまりブロックサイズ以下の読み書きは、ファイルシステムによって勝手にブロックサイズ単位に切り上げられてしまう)
- そのためアプリケーション (RDBMS) が書き込み単位をブロックサイズに切り上げてもほとんど同じになる
  - Linux の一般的なファイルシステムである `ext4` のデフォルトのブロックサイズは 4096 バイト (4KB)
  - 従ってページサイズも 4096 の整数倍にするのが一般的 (例えば MySQL ではデフォルトのページサイズは 16KB)

## DiskManager

DiskManager は個別のディスクファイルを管理する。各テーブルごとに 1 つの DiskManager が存在し、そのテーブルのページの読み書き操作を行う

具体的に行う操作は以下の通り

### ページの作成

- ページ ID を採番する
  - 格納されるデータの単位 = 4096 バイトになるため、ファイルサイズを 4096 で割った値が次のページ番号になる
    - 例:
      - ファイルサイズが 0 バイトの場合、次のページ番号は 0
      - ファイルサイズが 4096 バイトの場合、次のページ番号は 1
      - ファイルサイズが 8192 バイトの場合、次のページ番号は 2

### ページの読み込み

- 指定された PageId に対応するページからデータを読み込む
- 読み込みの前に、ファイルディスクリプタをページの先頭へシークし、指定されたページサイズ分のデータを読み込む
  - 例: PageNumber が 2 の場合、ファイルディスクリプタを 8192 バイト (2 * 4096) へシークしてからデータを読み込む

### ページの書き込み

- 指定された PageId に対応するページにデータを書き込む
- 書き込みの前に、ファイルディスクリプタをページの先頭へシークし、指定されたデータを書き込む
