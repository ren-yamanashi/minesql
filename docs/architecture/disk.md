# ディスク

- 該当コード:
  - [storage/disk/manager](../../internal/storage/disk/manager.go)

## 概要

- ディスクを読み書きする
  - バッファプール (バッファプールマネージャ) の要求通りにデータをディスクから呼び出し・書き込みを行う
- 読み書きするファイルはヒープファイル構造
  - ヒープファイル: ファイルをページという固定の長さごとに区切ったファイル
  - I/O 操作はページ単位 (最小の I/O 単位はページ)
  - 読み込み元、書き込み先のページはページ番号 (ページ ID) で指定
- ページサイズは 4096 バイト (4KB) とする

### 最小の I/O 単位をページにする理由

- ファイルはファイルシステムによって HDD や SDD などのデバイスにに書き込まれる
- この際ファイルシステムはブロック単位でデバイスに読み書きする (つまりブロックサイズ以下の読み書きは、ファイルシステムによって勝手にブロックサイズ単位に切り上げられてしまう)
- そのためアプリケーション (RDBMS) が書き込み単位をブロックサイズに切り上げてもほとんど同じになる
  - Linux の一般的なファイルシステムである `ext4` のデフォルトのブロックサイズは 4096 バイト (4KB)
  - 従ってページサイズも 4096 の整数倍にするのが一般的 (例えば MySQL ではデフォルトのページサイズは 16KB)

### ページの作成

- ページ ID を採番する
  - 格納されるデータの単位 = 4096 バイになるため、ファイルサイズを 4096 で割った値が次のページ ID になる
    - 例:
      - ファイルサイズが 0 バイトの場合、次のページ ID は 0
      - ファイルサイズが 4096 バイトの場合、次のページ ID は 1
      - ファイルサイズが 8192 バイトの場合、次のページ ID は 2

### ページの書き込み

- 指定されたページ番号に対応するページにデータを書き込む
- バリデーション:
  - 書き込むデータの長さがページサイズ (4096 バイト) と等しいことを確認
  - ページ番号が負でないことを確認
- 書き込みの前に、ファイルディスクリプタをページの先頭へシークし、指定されたデータを書き込む
  - ファイルディスクリプタ: プログラムからファイルを操作する際、操作対象のファイルを識別・同定するために割り当てられる番号
  - ファイルディスクリプタのシーク: ファイル内の特定の位置に読み書きのカーソルを移動させること (現在操作している位置を変更すること)

### ページの読み込み

- 指定されたページ番号に対応するページからデータを読み込む
- バリデーション:
  - ページ番号が負でないことを確認
  - 読み込み先のバッファの長さがページサイズ (4096 バイト) と等しいことを確認
- 読み込みの前に、ファイルディスクリプタをページの先頭へシークし、指定されたページサイズ分のデータを読み込む
